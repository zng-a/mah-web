function ue(){document.querySelectorAll(".donation-form").forEach(t=>{let i=Number(t.dataset.defaultAmount)||30,l=t.dataset.defaultFrequency||"one-off",q=t.dataset.defaultFundId||"",b=t.dataset.defaultFundName||"",P=!1,A=!1,f=!1,c=!1;const B=t.querySelectorAll(".df-amount"),R=t.querySelectorAll(".df-freq"),j=t.querySelectorAll(".df-fund-btn"),L=t.querySelector(".df-cta-btn"),F=t.querySelector(".df-cta-text"),G=t.querySelector(".df-cta-arrow"),H=t.querySelector(".df-cta-spinner"),p=t.querySelector(".df-custom-input"),y=t.querySelector(".df-custom-row"),g=t.querySelector(".df-error"),N=t.querySelector(".df-giftaid-check"),h=t.querySelector(".df-giftaid-fields"),O=t.querySelector(".df-giftaid-amount"),U=t.querySelector(".df-giftaid-total"),I=t.querySelector('input[name="email"]'),Z=t.querySelector("#payment-element"),w=t.querySelector("#payment-errors"),W=t.querySelector(".df-cover-fees-check"),E=t.querySelector(".df-cover-fees-box"),k=t.querySelector(".df-cover-fees-tick"),z=t.querySelector(".df-fee-amount");function ee(){const e=t.querySelector(`.df-freq[data-freq="${l}"]`);return e?.dataset.freqLabel?e.dataset.freqLabel:l===t.dataset.defaultFrequency&&t.dataset.defaultFreqLabel||""}function te(){if(l==="one-off")return"";const e=ee(),n=e.match(/\((.+?)\)/);return n?` for ${n[1]}`:` Every ${{Monthly:"Month",Weekly:"Week",Daily:"Day",Yearly:"Year"}[e]||e}`}const ne=.012,ae=.2;function J(e){const n=(e+ae)/(1-ne);return Math.round((n-e)*100)/100}function C(){return c?Math.round((i+J(i))*100)/100:i}function K(){const e=J(i);z&&(z.innerHTML=`&pound;${e.toFixed(2)}`)}function v(){if(!F||A)return;const e=C(),n=te();F.innerHTML=`Donate &pound;${e.toFixed(2)}${n}`}function M(){if(O&&(O.innerHTML=`&pound;${i}`),U){const e=Math.round(i*1.25*100)/100;U.innerHTML=`&pound;${e}`}K()}function D(e){g&&(g.textContent=e,g.classList.remove("hidden"),g.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>g.classList.add("hidden"),6e3))}function re(){g?.classList.add("hidden")}function Q(e){A=e,L&&(e?(F&&(F.textContent="Processing..."),G?.classList.add("hidden"),H?.classList.remove("hidden"),L.disabled=!0):(v(),G?.classList.remove("hidden"),H?.classList.add("hidden"),L.disabled=!1))}function $(e,n,o,s){n.forEach(a=>{a===e?(s.forEach(r=>a.classList.remove(r)),o.forEach(r=>a.classList.add(r))):(o.forEach(r=>a.classList.remove(r)),s.forEach(r=>a.classList.add(r)))})}j.forEach(e=>{e.addEventListener("click",()=>{q=e.dataset.fundId||"",b=e.dataset.fundName||"",$(e,j,["bg-navy","text-white","shadow-sm"],["bg-navy/[0.04]","text-navy","hover:bg-navy/[0.08]"])})}),B.forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.amount;n==="custom"?(P=!0,y&&(y.style.display=""),setTimeout(()=>p?.focus(),50)):(P=!1,i=Number(n),y&&(y.style.display="none")),$(e,B,["bg-teal","text-white","shadow-[0_2px_12px_rgba(68,131,158,0.3)]"],["bg-navy/[0.04]","text-navy","hover:bg-navy/[0.08]"]),v(),M(),x()})}),p?.addEventListener("input",()=>{const e=Number(p.value);e>0&&(i=e,v(),M(),x())}),R.forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.freq||"one-off",o=l!=="one-off",s=n!=="one-off";l=n,$(e,R,["bg-navy","text-white"],["bg-navy/[0.04]","text-navy","hover:bg-navy/[0.08]"]),v(),o!==s&&ce()})}),W?.addEventListener("change",()=>{c=W.checked,E&&(E.classList.toggle("bg-teal",c),E.classList.toggle("border-teal",c),E.classList.toggle("bg-white",!c),E.classList.toggle("border-navy/20",!c)),k&&(k.classList.toggle("opacity-0",!c),k.classList.toggle("opacity-100",c)),v(),x()}),N?.addEventListener("change",()=>{f=N.checked,h&&(f?(h.style.display="",h.offsetHeight,h.classList.add("is-open")):(h.classList.remove("is-open"),setTimeout(()=>{N.checked||(h.style.display="none")},350)))});function oe(){if(P){if(!p?.value||Number(p.value)<1)return"Please enter a valid donation amount.";i=Number(p.value)}if(!i||i<1)return"Please select a donation amount.";const e=I?.value?.trim();if(!e||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return"Please enter a valid email address.";if(f){const n=t.querySelector('input[name="firstName"]')?.value?.trim(),o=t.querySelector('input[name="lastName"]')?.value?.trim(),s=t.querySelector('input[name="address1"]')?.value?.trim(),a=t.querySelector('input[name="city"]')?.value?.trim(),r=t.querySelector('input[name="postcode"]')?.value?.trim();if(!n||!o)return"Please enter your full name for Gift Aid.";if(!s)return"Please enter your address for Gift Aid.";if(!a)return"Please enter your city for Gift Aid.";if(!r)return"Please enter your postcode for Gift Aid."}return null}let m=null,u=null,S=null;const ie={theme:"stripe",variables:{colorPrimary:"#44839e",colorText:"#0f243e",colorDanger:"#e53e3e",fontFamily:"Satoshi, system-ui, sans-serif",fontSizeBase:"16px",fontWeightNormal:"500",borderRadius:"14px",spacingUnit:"4px"},rules:{".Input":{backgroundColor:"rgba(15, 36, 62, 0.04)",border:"none",boxShadow:"none",padding:"15px 16px"},".Input:focus":{boxShadow:"0 0 0 2px rgba(68, 131, 158, 0.4)"},".Label":{fontSize:"13px",fontWeight:"700",color:"rgba(15, 36, 62, 0.45)",textTransform:"uppercase",letterSpacing:"0.04em"}}};function Y(){return Math.round(C()*100)}function se(){return l==="one-off"?"payment":"subscription"}function V(){if(!m)return;const e=se();u=m.elements({mode:e,amount:Y(),currency:"gbp",...e==="payment"&&{setupFutureUsage:"off_session"},appearance:ie}),S=u.create("payment",{layout:"tabs"}),S.mount(Z),S.on("change",n=>{w&&(n.error?(w.textContent=n.error.message,w.classList.remove("hidden")):(w.textContent="",w.classList.add("hidden")))})}function x(){u&&u.update({amount:Y()})}function ce(){m&&(S&&(S.destroy(),S=null),u=null,V())}async function de(){try{const n=await(await fetch("/api/stripe-publishable-key")).json();if(!n.publishableKey)return;window.Stripe||await new Promise((o,s)=>{const a=document.createElement("script");a.src="https://js.stripe.com/v3/",a.onload=()=>o(),a.onerror=()=>s(new Error("Failed to load Stripe.js")),document.head.appendChild(a)}),m=window.Stripe(n.publishableKey),V()}catch(e){console.error("Failed to init Stripe:",e)}}de(),K(),t.addEventListener("campaign-amount-update",(e=>{i=e.detail.amount,y&&(y.style.display="none"),v(),M(),x()})),L?.addEventListener("click",async()=>{if(A)return;re();const e=oe();if(e){D(e);return}if(!m||!u){D("Payment system is still loading. Please try again in a moment.");return}Q(!0);const n={amount:C(),frequency:l,fund:q||void 0,fundName:b||void 0,donorEmail:I?.value?.trim(),coversFees:c,giftAid:f,campaignId:t.dataset.campaignId||void 0,campaignType:t.dataset.campaignType||void 0,quantity:t.dataset.campaignQuantity?parseInt(t.dataset.campaignQuantity):void 0,ramadanStartDate:t.dataset.ramadanStartDate||void 0,totalInstallments:t.dataset.totalInstallments?parseInt(t.dataset.totalInstallments):void 0};n.campaignId&&console.log("[Frontend] Submitting campaign donation:",{campaignId:n.campaignId,campaignType:n.campaignType,quantity:n.quantity,amount:n.amount}),f&&(n.donorName=[t.querySelector('input[name="firstName"]')?.value?.trim(),t.querySelector('input[name="lastName"]')?.value?.trim()].filter(Boolean).join(" "),n.address={line1:t.querySelector('input[name="address1"]')?.value?.trim(),line2:t.querySelector('input[name="address2"]')?.value?.trim(),city:t.querySelector('input[name="city"]')?.value?.trim(),postcode:t.querySelector('input[name="postcode"]')?.value?.trim()});try{const{error:o}=await u.submit();if(o)throw new Error(o.message||"Please check your payment details.");const s=await fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),a=await s.json();if(!s.ok||!a.clientSecret)throw new Error(a.error||"Failed to create payment");const r=n.address,le=new URLSearchParams({donorEmail:I?.value?.trim()||"",frequency:l,coversFees:String(c),giftAid:String(f),...q&&{fund:q},...b&&{fundName:b},...n.donorName?{donorName:n.donorName}:{},...r?.line1?{addrLine1:r.line1}:{},...r?.line2?{addrLine2:r.line2}:{},...r?.city?{addrCity:r.city}:{},...r?.postcode?{addrPostcode:r.postcode}:{}}),X=`${window.location.origin}/donate/complete?${le.toString()}`;let T;if(a.isTrial&&a.setupIntentId){console.log("[Frontend] Confirming setup intent for trial subscription");const{error:d}=await m.confirmSetup({elements:u,clientSecret:a.clientSecret,confirmParams:{return_url:X},redirect:"if_required"});if(d)throw new Error(d.message||"Card verification failed");T=void 0}else{console.log("[Frontend] Confirming payment intent");const{error:d,paymentIntent:_}=await m.confirmPayment({elements:u,clientSecret:a.clientSecret,confirmParams:{return_url:X},redirect:"if_required"});if(d)throw new Error(d.message||"Payment failed");T=_?.id||a.paymentIntentId}if(T)try{const d=await fetch("/api/confirm-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:T,subscriptionId:a.subscriptionId||void 0,donorEmail:I?.value?.trim(),donorName:n.donorName||void 0,fund:q||void 0,fundName:b||void 0,frequency:l,coversFees:c,giftAid:f,...n.address&&{address:n.address}})});if(!d.ok){const _=await d.json().catch(()=>({}));console.error("Confirm payment failed:",_)}}catch(d){console.error("Confirm payment error:",d)}else console.log("[Frontend] Trial subscription - skipping confirm call (no payment intent yet)");window.location.href="/donate/success"}catch(o){Q(!1),D(o instanceof Error?o.message:"Something went wrong. Please try again.")}})})}ue();
