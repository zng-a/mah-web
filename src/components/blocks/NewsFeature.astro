---
import { mediaUrl, getLatestNews } from '../../lib/payload';
import type { News } from '../../lib/payload';

interface Props {
  block: {
    populateFrom?: 'latest' | 'manual' | null;
    featuredArticle?: News | null;
    sideArticles?: News[] | null;
    limit?: number | null;
    showViewAllLink?: boolean | null;
  };
}

const { block } = Astro.props;
const limit = block.limit ?? 3;

let articles: News[] = [];
if (block.populateFrom === 'manual' && block.featuredArticle) {
  articles = [block.featuredArticle, ...(block.sideArticles ?? [])];
} else {
  articles = await getLatestNews(limit).catch(() => []);
}

const featured = articles[0] ?? null;
const sideArticles = articles.slice(1);
---

<section class="px-5 md:px-10 py-8 lg:py-12">
  <div class="max-w-[1440px] mx-auto bg-teal-tint rounded-[24px] lg:rounded-[40px] p-6 md:p-8 lg:p-10">
    <div class="flex items-baseline justify-between mb-5 lg:mb-7">
      <h2 class="text-[24px] md:text-[28px] lg:text-[32px] font-bold leading-tight">Latest News & Announcements</h2>
      {block.showViewAllLink !== false && (
        <a href="/news" class="text-teal text-[14px] lg:text-[16px] font-medium border border-teal rounded-full px-4 lg:px-5 py-1.5 lg:py-2 hover:bg-teal hover:text-white transition-colors whitespace-nowrap">See all news</a>
      )}
    </div>

    {featured && (
      <a href={`/news/${featured.slug}`} class="block relative rounded-xl lg:rounded-2xl overflow-hidden aspect-[672/280] mb-5 lg:mb-7 group">
        <img
          src={mediaUrl(featured.featuredImage, 'card') || '/images/hero.jpeg'}
          alt={typeof featured.featuredImage === 'object' ? featured.featuredImage.alt : featured.title}
          class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
        <div class="absolute bottom-0 left-0 right-0 p-5 md:p-8">
          <h3 class="text-white text-[22px] md:text-[26px] lg:text-[30px] font-medium leading-tight">{featured.title}</h3>
          {featured.excerpt && (
            <p class="text-white/90 text-[13px] lg:text-[15px] leading-relaxed mt-1.5 lg:mt-2 max-w-[560px]">{featured.excerpt}</p>
          )}
        </div>
      </a>
    )}

    {sideArticles.length > 0 && (
      <div class="grid grid-cols-2 gap-4 lg:gap-6">
        {sideArticles.map((article) => (
          <a href={`/news/${article.slug}`} class="group">
            <div class="rounded-lg lg:rounded-xl overflow-hidden aspect-[322/126]">
              <img
                src={mediaUrl(article.featuredImage, 'card') || '/images/hero.jpeg'}
                alt={typeof article.featuredImage === 'object' ? article.featuredImage.alt : article.title}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              />
            </div>
            <h3 class="text-[16px] lg:text-[20px] font-medium leading-snug mt-2 lg:mt-3 group-hover:text-teal transition-colors">{article.title}</h3>
          </a>
        ))}
      </div>
    )}
  </div>
</section>
