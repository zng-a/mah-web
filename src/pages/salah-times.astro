---
import Base from '../layouts/Base.astro';
import { getTodayPrayerTimes, getMonthPrayerTimes } from '../lib/prayer-times';

const prayerData = await getTodayPrayerTimes();
const monthData = await getMonthPrayerTimes();

const nextPrayerName = prayerData?.nextPrayer?.name ?? null;

// Get current month/year for header
const now = new Date();
const monthYear = now.toLocaleDateString('en-GB', { month: 'long', year: 'numeric', timeZone: 'Europe/London' });
---

<Base title="Salah Times" prayerData={prayerData}>
  <main class="max-w-[1440px] mx-auto px-5 md:px-10 py-8 md:py-12 lg:py-16">

    <!-- Page Header -->
    <div class="text-center mb-8 lg:mb-12">
      <h1 class="text-[36px] md:text-[48px] lg:text-[56px] font-bold text-navy leading-tight mb-2">
        Salah Times
      </h1>
      <p class="text-[16px] md:text-[18px] text-muted max-w-2xl mx-auto">
        Complete prayer schedule with daily and monthly timetables
      </p>
    </div>

    {prayerData && (
      <>
        <!-- Today's Prayer Times Widget (Clean Style) -->
        <div class="bg-light-bg rounded-[24px] lg:rounded-[40px] p-4 md:p-5 lg:p-6 mb-6 lg:mb-8">

          <!-- Date Header -->
          <div class="flex items-center justify-between text-muted text-[13px] md:text-[14px] mb-3 md:mb-4">
            <span class="font-semibold">{prayerData.date}</span>
            {prayerData.hijriDate && prayerData.hijriDate !== '0' && <span class="font-medium">{prayerData.hijriDate}</span>}
          </div>

          <!-- Mobile: row-per-prayer layout -->
          <div class="md:hidden">
            {prayerData.nextPrayer && (
              <div class="flex items-center gap-2 mb-3 bg-green/10 border border-green/25 rounded-xl px-4 py-2.5">
                <div class="text-[12px] uppercase tracking-wide font-semibold text-green/70">Next</div>
                <div class="text-green text-[15px] font-bold">{prayerData.nextPrayer.name}</div>
                <div class="text-navy/50 text-[12px] font-medium">Jama'ah</div>
                <div class="text-green text-[15px] font-bold ml-auto">{prayerData.nextPrayer.jamaah}</div>
              </div>
            )}
            <div class="bg-white rounded-xl overflow-hidden border border-navy/5">
              <!-- Header row -->
              <div class="grid grid-cols-3 bg-navy text-white text-[11px] uppercase tracking-wide font-semibold px-4 py-2">
                <span>Prayer</span>
                <span class="text-center">Begins</span>
                <span class="text-right">Jama'ah</span>
              </div>
              {prayerData.prayers.filter(p => p.name !== 'Sunrise').map((p) => {
                const isNext = p.name === nextPrayerName;
                return (
                  <div class={`grid grid-cols-3 items-center px-4 py-3 border-t border-navy/5 ${isNext ? 'bg-teal/8 border-l-4 border-l-teal' : ''}`}>
                    <span class={`text-[13px] font-bold uppercase tracking-wide ${isNext ? 'text-teal' : 'text-navy/60'}`}>
                      {p.name === 'Maghrib' ? 'Magh' : p.name}
                    </span>
                    <span class={`text-center text-[15px] font-semibold ${isNext ? 'text-green/80' : 'text-navy/60'}`}>
                      {p.begins}
                    </span>
                    <span class={`text-right text-[16px] font-bold ${isNext ? 'text-green' : 'text-navy'}`}>
                      {p.jamaah}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>

          <!-- Tablet/Desktop: column grid layout -->
          <div class="hidden md:flex items-center gap-4 md:gap-6">
            <div class="grid grid-cols-5 gap-2 md:gap-3 flex-1">
              {prayerData.prayers.filter(p => p.name !== 'Sunrise').map((p) => {
                const isNext = p.name === nextPrayerName;
                return (
                  <div class={`rounded-xl py-3 px-2 text-center transition-all ${isNext ? 'bg-teal/15 border-2 border-teal/30' : 'bg-white border-2 border-navy/5 hover:border-navy/10'}`}>
                    <div class={`text-[11px] uppercase tracking-wide mb-2 font-semibold ${isNext ? 'text-teal' : 'text-navy/50'}`}>
                      {p.name === 'Maghrib' ? 'Magh' : p.name}
                    </div>
                    <div class="space-y-1">
                      <div>
                        <div class={`text-[15px] font-bold ${isNext ? 'text-green' : 'text-navy'}`}>{p.jamaah}</div>
                        <div class={`text-[10px] font-medium ${isNext ? 'text-teal/70' : 'text-navy/40'}`}>Jama'ah</div>
                      </div>
                      <div>
                        <div class={`text-[15px] font-semibold ${isNext ? 'text-green/80' : 'text-navy/70'}`}>{p.begins}</div>
                        <div class={`text-[10px] font-medium ${isNext ? 'text-teal/60' : 'text-navy/40'}`}>Begins</div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            {prayerData.nextPrayer && (
              <div class="border-l-2 border-navy/10 pl-4 md:pl-6 pr-2 shrink-0">
                <div class="text-muted text-[11px] uppercase tracking-wide font-semibold mb-1">Next Prayer</div>
                <div class="text-green text-[20px] lg:text-[22px] font-bold whitespace-nowrap">{prayerData.nextPrayer.name}</div>
                <div class="text-navy text-[15px] font-semibold">{prayerData.nextPrayer.jamaah}</div>
              </div>
            )}
          </div>
        </div>

        <!-- Monthly Timetable -->
        {monthData && monthData.length > 0 && (
          <div class="bg-white rounded-[24px] lg:rounded-[40px] border-2 border-navy/5 overflow-hidden shadow-sm">

            <!-- Section Header -->
            <div class="bg-light-bg px-6 md:px-8 lg:px-10 py-6 lg:py-8 border-b-2 border-navy/5">
              <h2 class="text-[28px] lg:text-[34px] font-bold text-navy leading-tight mb-1">
                Monthly Timetable
              </h2>
              <p class="text-[15px] lg:text-[16px] text-muted font-medium">{monthYear}</p>
            </div>

            <!-- Table Container (Scrollable on mobile) -->
            <div class="overflow-x-auto">
              <table class="w-full min-w-[800px]">
                <!-- Table Header -->
                <thead>
                  <tr class="bg-navy text-white">
                    <th rowspan="2" class="text-left py-4 lg:py-5 px-4 lg:px-6 font-bold text-[14px] lg:text-[16px] border-r border-white/10">
                      Date
                    </th>
                    <th colspan="2" class="text-center py-2 lg:py-3 px-2 font-bold text-[14px] lg:text-[16px] border-r border-white/10">
                      Fajr
                    </th>
                    <th colspan="2" class="text-center py-2 lg:py-3 px-2 font-bold text-[14px] lg:text-[16px] border-r border-white/10">
                      Zuhr
                    </th>
                    <th colspan="2" class="text-center py-2 lg:py-3 px-2 font-bold text-[14px] lg:text-[16px] border-r border-white/10">
                      'Asr
                    </th>
                    <th colspan="2" class="text-center py-2 lg:py-3 px-2 font-bold text-[14px] lg:text-[16px] border-r border-white/10">
                      Maghrib
                    </th>
                    <th colspan="2" class="text-center py-2 lg:py-3 px-2 font-bold text-[14px] lg:text-[16px]">
                      'Isha
                    </th>
                  </tr>
                  <tr class="bg-teal text-white">
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/20">Begins</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/10">Jama'ah</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/20">Begins</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/10">Jama'ah</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/20">Begins</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/10">Jama'ah</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/20">Begins</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/10">Jama'ah</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px] border-r border-white/20">Begins</th>
                    <th class="text-center py-2 lg:py-2.5 px-2 font-medium text-[12px] lg:text-[13px]">Jama'ah</th>
                  </tr>
                </thead>

                <!-- Table Body -->
                <tbody class="divide-y divide-navy/5">
                  {monthData.map((day, index) => (
                    <tr class={`transition-colors ${day.isToday ? 'bg-green/15 border-l-[6px] border-green' : index % 2 === 1 ? 'bg-navy/[0.02]' : 'hover:bg-navy/[0.03]'}`}>
                      <!-- Date Column -->
                      <td class="py-3 lg:py-3.5 px-4 lg:px-6 border-r border-navy/5">
                        <div class={`font-bold text-[14px] lg:text-[15px] ${day.isToday ? 'text-green' : 'text-navy'}`}>
                          {day.date}
                        </div>
                        {day.hijriDate && day.hijriDate !== '0' && (
                          <div class={`text-[11px] lg:text-[12px] mt-0.5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>
                            {day.hijriDate}
                          </div>
                        )}
                      </td>

                      <!-- Fajr -->
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] border-r border-navy/5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>{day.fajr.begins}</td>
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] font-bold border-r border-navy/5 ${day.isToday ? 'text-green' : 'text-navy'}`}>{day.fajr.jamaah}</td>

                      <!-- Zuhr -->
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] border-r border-navy/5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>{day.zuhr.begins}</td>
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] font-bold border-r border-navy/5 ${day.isToday ? 'text-green' : 'text-navy'}`}>{day.zuhr.jamaah}</td>

                      <!-- Asr -->
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] border-r border-navy/5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>{day.asr.begins}</td>
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] font-bold border-r border-navy/5 ${day.isToday ? 'text-green' : 'text-navy'}`}>{day.asr.jamaah}</td>

                      <!-- Maghrib -->
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] border-r border-navy/5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>{day.maghrib.begins}</td>
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] font-bold border-r border-navy/5 ${day.isToday ? 'text-green' : 'text-navy'}`}>{day.maghrib.jamaah}</td>

                      <!-- Isha -->
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] border-r border-navy/5 ${day.isToday ? 'text-green/70' : 'text-muted'}`}>{day.isha.begins}</td>
                      <td class={`text-center py-3 lg:py-3.5 px-2 text-[13px] lg:text-[14px] font-bold ${day.isToday ? 'text-green' : 'text-navy'}`}>{day.isha.jamaah}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <!-- Footer Note -->
            <div class="bg-light-bg px-6 md:px-8 lg:px-10 py-5 border-t-2 border-navy/5">
              <p class="text-[13px] lg:text-[14px] text-muted text-center">
                <strong class="font-bold text-navy">Jama'ah times</strong> are when the congregation begins.
                <span class="ml-1">Please arrive early to ensure you don't miss the prayer.</span>
              </p>
            </div>
          </div>
        )}
      </>
    )}

    {!prayerData && (
      <div class="text-center py-16">
        <p class="text-muted text-[18px]">Prayer times are currently unavailable. Please check back later.</p>
      </div>
    )}

  </main>
</Base>
