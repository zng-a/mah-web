---
import '../styles/global.css';
import { initRuntimeEnv } from '../lib/runtime-env';
import { mediaUrl, getRuntimeConfig } from '../lib/payload';

initRuntimeEnv(Astro);

const { PAYLOAD_URL, TENANT_ID } = getRuntimeConfig();

interface NewsItem {
  id: string;
  title: string;
  excerpt?: string;
  publishedDate: string;
  slug: string;
  featuredImage?: unknown;
}

let newsItems: NewsItem[] = [];

try {
  const res = await fetch(
    `${PAYLOAD_URL}/api/news?where[tenant][equals]=${TENANT_ID}&sort=-publishedDate&limit=20`,
    { headers: { 'Content-Type': 'application/json' } }
  );
  if (res.ok) {
    const json = await res.json();
    newsItems = json?.docs ?? [];
  }
} catch (e) {
  console.error('Failed to fetch news:', e);
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet" />
    <title>News - Masjid Al-Hikmah</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: 'Satoshi', -apple-system, system-ui, sans-serif;
        background: #f5f5f5;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header style="background: #0A1C30; padding: 40px 20px 30px; text-align: center;">
      <img
        src="/images/logo-white.png"
        alt="Masjid Al-Hikmah"
        style="width: 150px; height: auto; margin: 0 auto;"
      />
    </header>

    <!-- Navigation Tabs -->
    <nav style="display: flex; background: #0A1C30; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
      <a href="/mobile" style="flex: 1; padding: 18px; text-align: center; color: rgba(255,255,255,0.85); font-weight: 700; font-size: 18px; text-decoration: none; border-bottom: 3px solid transparent;">
        Salah
      </a>
      <a href="/mobile-donate" style="flex: 1; padding: 18px; text-align: center; color: rgba(255,255,255,0.85); font-weight: 700; font-size: 18px; text-decoration: none; border-bottom: 3px solid transparent;">
        Donate
      </a>
      <a href="/news-mobile" style="flex: 1; padding: 18px; text-align: center; color: white; font-weight: 700; font-size: 18px; text-decoration: none; background: rgba(255,255,255,0.15); border-bottom: 3px solid white;">
        News
      </a>
    </nav>

    <!-- Content -->
    <main style="padding: 20px; max-width: 600px; margin: 0 auto;">
      {newsItems.length > 0 ? (
        <div style="display: flex; flex-direction: column; gap: 16px;">
          {newsItems.map((item) => {
            const imgSrc = item.featuredImage ? mediaUrl(item.featuredImage, 'card') : null;
            return (
              <a
                href={`/news/${item.slug}`}
                style="display: block; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); text-decoration: none; transition: transform 0.2s, box-shadow 0.2s;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 12px rgba(0,0,0,0.08)'"
              >
                {imgSrc && (
                  <img
                    src={imgSrc}
                    alt={item.title}
                    style="width: 100%; height: 200px; object-fit: cover;"
                  />
                )}
                <div style="padding: 20px;">
                  <div style="color: #44839e; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                    {formatDate(item.publishedDate)}
                  </div>
                  <h3 style="color: #0f243e; font-size: 18px; font-weight: 700; line-height: 1.4; margin-bottom: 8px;">
                    {item.title}
                  </h3>
                  {item.excerpt && (
                    <p style="color: #666; font-size: 15px; line-height: 1.6;">
                      {item.excerpt}
                    </p>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div style="background: white; border-radius: 16px; padding: 40px 20px; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
          <p style="color: #666; font-size: 16px;">No news available at the moment.</p>
        </div>
      )}
    </main>
  </body>
</html>
