---
import Base from '../../layouts/Base.astro';
import { getNewsBySlug, getLatestNews, mediaUrl } from '../../lib/payload';
import { lexicalToHtml } from '../../lib/lexical';
import { initRuntimeEnv } from '../../lib/runtime-env';
import { getTodayPrayerTimes } from '../../lib/prayer-times';
import type { PrayerTimesData } from '../../lib/prayer-times';

initRuntimeEnv(Astro);

const { slug } = Astro.params;

const [article, prayerData] = await Promise.all([
  getNewsBySlug(slug!).catch(() => null),
  getTodayPrayerTimes().catch(() => null as PrayerTimesData | null),
]);

if (!article) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const contentHtml = article.content ? lexicalToHtml(article.content) : '';
const heroUrl = mediaUrl(article.featuredImage);

const formattedDate = new Date(article.publishedDate).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});

const relatedArticles = await getLatestNews(4)
  .then(articles => articles.filter(a => a.slug !== article.slug).slice(0, 3))
  .catch(() => []);
---

<Base title={article.title} prayerData={prayerData}>
  <div class="max-w-[1200px] mx-auto px-5 md:px-10">
    <!-- Breadcrumb -->
    <div class="flex items-center gap-3 text-[13px] md:text-[14px] py-4">
      <a href="/news" class="inline-flex items-center gap-2 text-teal hover:text-navy transition-colors font-medium">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        <span>Back</span>
      </a>
      <span class="text-muted">/</span>
      <a href="/news" class="text-teal hover:text-navy transition-colors font-medium">News</a>
      <span class="text-muted">/</span>
      <span class="text-navy truncate max-w-[180px] sm:max-w-xs">{article.title}</span>
    </div>

    <!-- Article -->
    <article class="max-w-[740px] mx-auto py-6 md:py-10">
      <!-- Date -->
      <time class="text-[13px] text-teal font-semibold uppercase tracking-wider block mb-3">
        {formattedDate}
      </time>

      <!-- Title -->
      <h1 class="text-navy text-[28px] sm:text-[36px] md:text-[42px] font-bold leading-[1.15] tracking-[-0.01em] mb-5">
        {article.title}
      </h1>

      <!-- Excerpt -->
      {article.excerpt && (
        <p class="text-[17px] md:text-[18px] text-navy/65 leading-[1.75] mb-8 pl-4 border-l-4 border-teal">
          {article.excerpt}
        </p>
      )}

      <!-- Hero Image -->
      {heroUrl && (
        <a href={heroUrl} target="_blank" rel="noopener noreferrer" class="block mb-8 rounded-[16px] overflow-hidden bg-navy/5 group">
          <img
            src={heroUrl}
            alt={article.title}
            class="w-full h-auto block group-hover:opacity-95 transition-opacity"
            fetchpriority="high"
          />
        </a>
      )}

      <div class="h-px bg-navy/[0.08] mb-8"></div>

      <!-- Body -->
      {contentHtml ? (
        <div class="news-prose" set:html={contentHtml} />
      ) : (
        <p class="text-muted text-[16px]">No content available for this article.</p>
      )}
    </article>

    <!-- Related Articles -->
    {relatedArticles.length > 0 && (
      <section class="max-w-[740px] mx-auto pb-12 md:pb-16">
        <div class="h-px bg-navy/[0.08] mb-8"></div>
        <h2 class="text-navy text-[20px] font-bold mb-5">More News</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          {relatedArticles.map(related => {
            const relatedImg = mediaUrl(related.featuredImage, 'card');
            const relatedDate = new Date(related.publishedDate).toLocaleDateString('en-GB', {
              day: 'numeric', month: 'short', year: 'numeric',
            });
            return (
              <a href={`/news/${related.slug}`} class="group block">
                <div class="rounded-[16px] overflow-hidden border border-navy/[0.07] hover:border-teal/30 transition-colors">
                  {relatedImg && (
                    <div class="aspect-[16/9] overflow-hidden bg-navy/5">
                      <img
                        src={relatedImg}
                        alt={related.title}
                        class="w-full h-full object-cover group-hover:scale-[1.04] transition-transform duration-300"
                      />
                    </div>
                  )}
                  <div class="p-4">
                    <time class="text-[12px] text-teal font-semibold uppercase tracking-wide block mb-1.5">
                      {relatedDate}
                    </time>
                    <h3 class="text-navy text-[14px] font-bold leading-snug group-hover:text-teal transition-colors line-clamp-2">
                      {related.title}
                    </h3>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </div>
</Base>

<style>
  .news-prose {
    color: var(--color-navy);
    font-size: 16px;
    line-height: 1.85;
  }

  .news-prose :global(h2) {
    font-size: 22px;
    font-weight: 700;
    margin-top: 2.25rem;
    margin-bottom: 0.75rem;
    line-height: 1.3;
  }

  .news-prose :global(h3) {
    font-size: 18px;
    font-weight: 700;
    margin-top: 1.75rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .news-prose :global(p) {
    margin-bottom: 1.35rem;
  }

  .news-prose :global(a) {
    color: var(--color-teal);
    text-decoration: underline;
    text-underline-offset: 3px;
  }
  .news-prose :global(a:hover) {
    opacity: 0.8;
  }

  .news-prose :global(strong) {
    font-weight: 700;
  }

  .news-prose :global(em) {
    font-style: italic;
  }

  .news-prose :global(ul) {
    list-style: disc;
    padding-left: 1.5rem;
    margin-bottom: 1.35rem;
  }

  .news-prose :global(ol) {
    list-style: decimal;
    padding-left: 1.5rem;
    margin-bottom: 1.35rem;
  }

  .news-prose :global(li) {
    margin-bottom: 0.35rem;
  }

  .news-prose :global(blockquote) {
    border-left: 4px solid var(--color-teal);
    padding-left: 1rem;
    color: rgba(15, 36, 62, 0.6);
    font-style: italic;
    margin-bottom: 1.35rem;
  }

  .news-prose :global(img) {
    border-radius: 12px;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    height: auto;
  }

  .news-prose :global(hr) {
    border: none;
    border-top: 1px solid rgba(15, 36, 62, 0.08);
    margin: 2rem 0;
  }

  .news-prose :global(code) {
    font-family: monospace;
    font-size: 0.9em;
    background: rgba(15, 36, 62, 0.05);
    padding: 0.15em 0.4em;
    border-radius: 4px;
  }
</style>
