---
import '../../styles/global.css';
import { initRuntimeEnv } from '../../lib/runtime-env';
import { getNewsBySlug, mediaUrl } from '../../lib/payload';
import { lexicalToHtml } from '../../lib/lexical';

initRuntimeEnv(Astro);

const { slug } = Astro.params;

const article = await getNewsBySlug(slug!).catch(() => null);

if (!article) {
  return Astro.redirect('/news-mobile');
}

const contentHtml = article.content ? lexicalToHtml(article.content) : '';
const heroUrl = mediaUrl(article.featuredImage);

const formattedDate = new Date(article.publishedDate).toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});
---

<html lang="en" style="background: #0A1C30">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0A1C30" />
    <link rel="manifest" href="/site.webmanifest" />
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet" />
    <title>{article.title}</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: 'Satoshi', -apple-system, system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }
      .pwa-header {
        background: #0A1C30;
        padding-top: max(env(safe-area-inset-top) + 12px, 20px);
        padding-bottom: 14px;
        padding-left: 20px;
        padding-right: 20px;
        text-align: center;
      }
      .news-prose {
        color: #0f243e;
        font-size: 16px;
        line-height: 1.85;
      }
      .news-prose h2 {
        font-size: 20px;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
        line-height: 1.3;
      }
      .news-prose h3 {
        font-size: 17px;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .news-prose p {
        margin-bottom: 1.25rem;
      }
      .news-prose a {
        color: #44839e;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .news-prose strong { font-weight: 700; }
      .news-prose em { font-style: italic; }
      .news-prose ul {
        list-style: disc;
        padding-left: 1.5rem;
        margin-bottom: 1.25rem;
      }
      .news-prose ol {
        list-style: decimal;
        padding-left: 1.5rem;
        margin-bottom: 1.25rem;
      }
      .news-prose li { margin-bottom: 0.3rem; }
      .news-prose blockquote {
        border-left: 4px solid #44839e;
        padding-left: 1rem;
        color: rgba(15, 36, 62, 0.6);
        font-style: italic;
        margin-bottom: 1.25rem;
      }
      .news-prose img {
        border-radius: 12px;
        margin: 1.25rem 0;
        width: 100%;
        height: auto;
      }
      .news-prose hr {
        border: none;
        border-top: 1px solid rgba(15, 36, 62, 0.08);
        margin: 1.75rem 0;
      }
    </style>
  </head>
  <body style="background: #0A1C30">
    <!-- Header -->
    <header class="pwa-header">
      <img
        src="/images/logo-white.png"
        alt="Masjid Al-Hikmah"
        style="width: 145px; height: auto; margin: 0 auto;"
      />
    </header>

    <!-- Navigation Tabs -->
    <nav style="display: flex; background: #0A1C30; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
      <a href="/mobile" style="flex: 1; padding: 12px; text-align: center; color: rgba(255,255,255,0.85); font-weight: 700; font-size: 16px; text-decoration: none; border-bottom: 3px solid transparent;">
        Salah
      </a>
      <a href="/mobile-donate" style="flex: 1; padding: 12px; text-align: center; color: rgba(255,255,255,0.85); font-weight: 700; font-size: 16px; text-decoration: none; border-bottom: 3px solid transparent;">
        Donate
      </a>
      <a href="/news-mobile" style="flex: 1; padding: 12px; text-align: center; color: white; font-weight: 700; font-size: 16px; text-decoration: none; background: rgba(255,255,255,0.15); border-bottom: 3px solid white;">
        News
      </a>
    </nav>

    <!-- Content -->
    <main style="padding: 0 16px 40px; max-width: 600px; margin: 0 auto; background: #f5f5f5; min-height: 100vh;">

      <!-- Back -->
      <div style="padding-top: 24px; padding-bottom: 8px;">
        <a href="/news-mobile" style="display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; color: rgba(15,36,62,0.5); text-decoration: none;">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          Back
        </a>
      </div>

      <article>
        <!-- Date -->
        <time style="display: block; font-size: 12px; font-weight: 600; color: #44839e; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">
          {formattedDate}
        </time>

        <!-- Title -->
        <h1 style="color: #0f243e; font-size: 24px; font-weight: 700; line-height: 1.2; letter-spacing: -0.01em; margin-bottom: 16px;">
          {article.title}
        </h1>

        <!-- Excerpt -->
        {article.excerpt && (
          <p style="font-size: 15px; color: rgba(15,36,62,0.65); line-height: 1.7; margin-bottom: 20px; padding-left: 16px; border-left: 4px solid #44839e;">
            {article.excerpt}
          </p>
        )}

        <!-- Hero Image -->
        {heroUrl && (
          <a href={heroUrl} target="_blank" rel="noopener noreferrer" style="display: block; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: rgba(15,36,62,0.05);">
            <img
              src={heroUrl}
              alt={article.title}
              style="width: 100%; height: auto; display: block;"
              fetchpriority="high"
            />
          </a>
        )}

        <div style="height: 1px; background: rgba(15,36,62,0.08); margin-bottom: 24px;"></div>

        <!-- Body -->
        {contentHtml ? (
          <div class="news-prose" set:html={contentHtml} />
        ) : (
          <p style="color: #666; font-size: 16px;">No content available for this article.</p>
        )}
      </article>

    </main>
  </body>
</html>
