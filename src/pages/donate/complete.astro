---
import Base from '../../layouts/Base.astro';
import { initRuntimeEnv } from '../../lib/runtime-env';
import { getDonateSettings } from '../../lib/payload';
import type { DonateSettings } from '../../lib/payload';

initRuntimeEnv(Astro);

let donateSettings: DonateSettings | null = null;
try {
  donateSettings = await getDonateSettings();
} catch {
  // Use defaults
}

const successMessage = donateSettings?.successMessage
  ?? 'JazakAllahu Khairan! Your donation has been received. May Allah reward you abundantly.';
---

<Base title="Donation Complete">
  <div class="max-w-[1440px] mx-auto px-5 md:px-10">
    <div class="min-h-[60vh] flex items-center justify-center">
      <div class="text-center max-w-[520px]" id="complete-container">
        <!-- Loading state (shown while confirming) -->
        <div id="state-loading">
          <div class="w-[80px] h-[80px] rounded-full bg-navy/5 flex items-center justify-center mx-auto mb-6">
            <svg class="animate-spin" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <circle cx="12" cy="12" r="10" stroke-opacity="0.25" />
              <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round" class="text-teal" />
            </svg>
          </div>
          <h1 class="text-navy text-[28px] sm:text-[36px] font-bold mb-3">Confirming your donation...</h1>
          <p class="text-[16px] leading-[1.7] text-muted">Please wait while we verify your payment.</p>
        </div>

        <!-- Success state -->
        <div id="state-success" class="hidden">
          <div class="w-[80px] h-[80px] rounded-full bg-teal/10 flex items-center justify-center mx-auto mb-6">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-teal">
              <path d="M20 6L9 17l-5-5" />
            </svg>
          </div>
          <h1 class="text-navy text-[32px] sm:text-[40px] font-bold mb-4">Thank You!</h1>
          <p class="text-[16px] sm:text-[18px] leading-[1.7] text-muted mb-8" id="success-message">
            {successMessage}
          </p>
          <a
            href="/"
            class="inline-flex items-center justify-center gap-2 bg-teal text-white font-bold text-[16px] rounded-xl h-[52px] px-8 hover:bg-teal/80 transition-colors"
          >
            Return Home
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14" /><path d="M12 5l7 7-7 7" />
            </svg>
          </a>
        </div>

        <!-- Processing state (Bacs Direct Debit) -->
        <div id="state-processing" class="hidden">
          <div class="w-[80px] h-[80px] rounded-full bg-amber-50 flex items-center justify-center mx-auto mb-6">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 6v6l4 2" />
            </svg>
          </div>
          <h1 class="text-navy text-[32px] sm:text-[40px] font-bold mb-4">Payment Submitted</h1>
          <p class="text-[16px] sm:text-[18px] leading-[1.7] text-muted mb-8">
            Your Direct Debit payment has been submitted and is being processed. This typically takes 2-3 business days to clear. You'll receive a confirmation once complete.
          </p>
          <a
            href="/"
            class="inline-flex items-center justify-center gap-2 bg-teal text-white font-bold text-[16px] rounded-xl h-[52px] px-8 hover:bg-teal/80 transition-colors"
          >
            Return Home
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14" /><path d="M12 5l7 7-7 7" />
            </svg>
          </a>
        </div>

        <!-- Error state -->
        <div id="state-error" class="hidden">
          <div class="w-[80px] h-[80px] rounded-full bg-red-50 flex items-center justify-center mx-auto mb-6">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-red-500">
              <circle cx="12" cy="12" r="10" />
              <path d="M15 9l-6 6" />
              <path d="M9 9l6 6" />
            </svg>
          </div>
          <h1 class="text-navy text-[32px] sm:text-[40px] font-bold mb-4">Payment Failed</h1>
          <p class="text-[16px] sm:text-[18px] leading-[1.7] text-muted mb-8">
            Your payment could not be processed. Please try again with a different payment method.
          </p>
          <a
            href="/donate"
            class="inline-flex items-center justify-center gap-2 bg-teal text-white font-bold text-[16px] rounded-xl h-[52px] px-8 hover:bg-teal/80 transition-colors"
          >
            Try Again
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14" /><path d="M12 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</Base>

<script>
  async function handleComplete() {
    const params = new URLSearchParams(window.location.search);
    const paymentIntent = params.get('payment_intent');
    const redirectStatus = params.get('redirect_status');
    const donorEmail = params.get('donorEmail') || '';
    const frequency = params.get('frequency') || 'one-off';
    const coversFees = params.get('coversFees') === 'true';
    const giftAid = params.get('giftAid') === 'true';
    const fund = params.get('fund') || undefined;
    const fundName = params.get('fundName') || undefined;
    const donorName = params.get('donorName') || undefined;
    const addrLine1 = params.get('addrLine1') || undefined;
    const addrLine2 = params.get('addrLine2') || undefined;
    const addrCity = params.get('addrCity') || undefined;
    const addrPostcode = params.get('addrPostcode') || undefined;

    const stateLoading = document.getElementById('state-loading')!;
    const stateSuccess = document.getElementById('state-success')!;
    const stateProcessing = document.getElementById('state-processing')!;
    const stateError = document.getElementById('state-error')!;

    function showState(state: 'loading' | 'success' | 'processing' | 'error') {
      stateLoading.classList.toggle('hidden', state !== 'loading');
      stateSuccess.classList.toggle('hidden', state !== 'success');
      stateProcessing.classList.toggle('hidden', state !== 'processing');
      stateError.classList.toggle('hidden', state !== 'error');
    }

    if (!paymentIntent || !redirectStatus) {
      showState('error');
      return;
    }

    if (redirectStatus === 'failed' || redirectStatus === 'requires_payment_method') {
      showState('error');
      return;
    }

    // Call confirm-payment to record the donation
    try {
      await fetch('/api/confirm-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paymentIntentId: paymentIntent,
          donorEmail,
          donorName,
          fund,
          fundName,
          frequency,
          coversFees,
          giftAid,
          ...(addrLine1 && { address: { line1: addrLine1, line2: addrLine2, city: addrCity, postcode: addrPostcode } }),
        }),
      });
    } catch {
      // Non-blocking â€” webhook is the fallback
    }

    if (redirectStatus === 'processing') {
      showState('processing');
    } else {
      // succeeded
      showState('success');
    }
  }

  handleComplete();
</script>
