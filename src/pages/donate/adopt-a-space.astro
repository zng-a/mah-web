---
import Base from '../../layouts/Base.astro';
import DonationForm from '../../components/blocks/DonationForm.astro';
import { initRuntimeEnv } from '../../lib/runtime-env';
import { getCampaignBySlug, getRuntimeConfig } from '../../lib/payload';
import { lexicalToHtml } from '../../lib/lexical';

initRuntimeEnv(Astro);

const campaign = await getCampaignBySlug('adopt-a-space');
if (!campaign || !campaign.active) {
  return Astro.redirect('/donate');
}

const { PAYLOAD_URL, TENANT_ID } = getRuntimeConfig();

const stripeRes = await fetch(`${PAYLOAD_URL}/api/stripe/publishable-key?tenant=${TENANT_ID}`)
  .then(r => r.json())
  .catch(() => ({ publishableKey: '' }));

const publishableKey = stripeRes?.publishableKey ?? '';

const pricePerSpace = campaign.fixedUnitConfig?.pricePerUnit || 20;
const maxQuantity = campaign.fixedUnitConfig?.maxQuantity || 100;
const totalSpaces = campaign.fixedUnitConfig?.totalUnits ?? null;
const effectiveSpacesSold = (campaign.currentUnits ?? 0) + (campaign.unitAdjustment ?? 0);
const spacesRemaining = totalSpaces != null ? Math.max(0, totalSpaces - effectiveSpacesSold) : null;
const spaceProgress = totalSpaces ? Math.min(100, (effectiveSpacesSold / totalSpaces) * 100) : 0;

// Convert description from Lexical to HTML
const descriptionHtml = campaign.description ? lexicalToHtml(campaign.description) : '';
---

<Base title={campaign.name}>
  {/* Breadcrumb with Back Button */}
  <div class="px-5 md:px-10 py-4">
    <div class="flex items-center gap-3 text-[13px] md:text-[14px]">
      <a href="/donate" class="inline-flex items-center gap-2 text-teal hover:text-navy transition-colors font-medium">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        <span>Back</span>
      </a>
      <span class="text-muted">/</span>
      <a href="/donate" class="text-teal hover:text-navy transition-colors font-medium">Donate</a>
      <span class="text-muted">/</span>
      <span class="text-navy">{campaign.name}</span>
    </div>
  </div>

  <div class="max-w-[1200px] mx-auto px-5 md:px-10 py-12">
    <div class="text-center mb-8">
      <h1 class="text-navy text-[32px] md:text-[38px] font-bold mb-3">{campaign.name}</h1>
      {descriptionHtml ? (
        <div class="text-[15px] md:text-[16px] text-muted max-w-[680px] mx-auto" set:html={descriptionHtml} />
      ) : (
        <p class="text-[15px] md:text-[16px] text-muted max-w-[680px] mx-auto">
          Leave a lasting legacy by sponsoring spaces for our new masjid building.
          Each space represents your contribution to this blessed project.
        </p>
      )}
    </div>

    <div class="max-w-[900px] mx-auto">
      {/* Spaces Remaining Progress */}
      {spacesRemaining != null && (
        <div class="bg-navy/[0.03] border border-navy/[0.08] rounded-2xl px-6 py-5 mb-8 text-center">
          <div class="flex items-baseline justify-center gap-2 mb-1">
            <span class="text-[32px] md:text-[38px] font-bold text-teal">{spacesRemaining.toLocaleString()}</span>
            <span class="text-[15px] md:text-[16px] text-navy/60">spaces remaining</span>
          </div>
          <p class="text-[13px] text-navy/50 mb-4">out of {totalSpaces!.toLocaleString()} total spaces</p>
          <div class="relative h-2.5 bg-navy/[0.08] rounded-full overflow-hidden">
            <div
              class="absolute inset-y-0 left-0 bg-gradient-to-r from-teal to-green rounded-full transition-all duration-700 ease-out"
              style={`width: ${spaceProgress}%`}
            >
              <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/30 to-white/0" style="animation: shimmer 2.5s infinite;"></div>
            </div>
          </div>
          <p class="text-[12px] text-navy/40 mt-2">{Math.round(spaceProgress)}% of spaces adopted</p>
        </div>
      )}

      {/* Feature Pills */}
      <div class="flex flex-wrap items-center justify-center gap-2 mb-6">
        {[
          'One-time payment',
          'Lasting legacy',
          'Gift Aid eligible',
          'Secure payment'
        ].map(feature => (
          <div class="inline-flex items-center gap-1.5 bg-teal/[0.08] border border-teal/20 rounded-full px-3 md:px-4 py-1.5 text-[12px] md:text-[13px] font-medium text-navy">
            <svg class="w-3.5 h-3.5 text-teal shrink-0" fill="currentColor" viewBox="0 0 16 16">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
            <span>{feature}</span>
          </div>
        ))}
      </div>

      <!-- Integrated space selector within the donation flow -->
      <div class="mb-6">
        <DonationForm
          block={{
            heading: 'Adopt Your Spaces',
            description: `£${pricePerSpace} per space`,
            funds: campaign.fund ? [campaign.fund] : [],
            amounts: [pricePerSpace].map(v => ({ value: v })),
            frequencies: [{ label: 'One-off', value: 'one-off' }],
            style: 'card',
            publishableKey: publishableKey,
            campaign: campaign,
            campaignType: 'fixed-unit',
            paymentMethods: ['card'],
            hideFundSelector: true,
            hideFrequencySelector: true,
          }}
        />
      </div>
    </div>
  </div>
</Base>

<style>
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
</style>

<script define:vars={{ pricePerSpace, maxQuantity }}>
  // Wait for DOM and donation form to be ready
  document.addEventListener('DOMContentLoaded', () => {
    const donationForm = document.querySelector('.donation-form');
    if (!donationForm) return;

    // Replace amount grid with space quantity selector
    const amountGrid = donationForm.querySelector('.df-amount-grid');
    if (amountGrid) {
      // Create space selector HTML
      const spaceSelector = `
        <div class="mb-3">
          <label class="df-label">Number of Spaces</label>
          <div class="grid grid-cols-4 gap-[6px] mb-3">
            ${[1, 2, 5, 10].map((qty, idx) => `
              <button
                type="button"
                data-space-qty="${qty}"
                class="space-qty-btn font-bold text-[17px] rounded-[14px] h-[52px] transition-all duration-200 ${
                  idx === 0
                    ? 'bg-teal text-white shadow-[0_2px_12px_rgba(68,131,158,0.3)]'
                    : 'bg-navy/[0.04] text-navy hover:bg-navy/[0.08]'
                }"
              >
                ${qty}
              </button>
            `).join('')}
            <button
              type="button"
              data-space-qty="custom"
              class="space-qty-btn bg-navy/[0.04] text-navy font-bold text-[15px] rounded-[14px] h-[52px] hover:bg-navy/[0.08] transition-all duration-200"
            >
              Custom
            </button>
          </div>
          <div id="space-custom-row" style="display:none;">
            <input
              type="number"
              min="1"
              max="${maxQuantity}"
              value="1"
              id="space-quantity"
              class="w-full h-[52px] px-4 rounded-[14px] bg-navy/[0.04] border-2 border-transparent font-bold text-[18px] text-navy focus:border-teal focus:outline-none transition-all mb-3"
              placeholder="Enter quantity"
            />
          </div>
          <p class="text-[14px] text-navy/60">
            £${pricePerSpace} per space • Total: <span id="space-total" class="font-bold text-teal">£${pricePerSpace}</span>
          </p>
        </div>
      `;

      // Replace the amount grid with space selector
      const parentDiv = amountGrid.parentElement;
      if (parentDiv) {
        parentDiv.innerHTML = spaceSelector;
      }

      // Set up space quantity handlers
      setTimeout(() => {
        const spaceButtons = donationForm.querySelectorAll('.space-qty-btn');
        const quantityInput = document.getElementById('space-quantity');
        const customRow = document.getElementById('space-custom-row');
        const totalDisplay = document.getElementById('space-total');

        function updateSpaceAmount(quantity) {
          const amount = quantity * pricePerSpace;
          if (totalDisplay) totalDisplay.textContent = `£${amount}`;

          // Update button states
          spaceButtons.forEach(btn => {
            const isActive = btn.dataset.spaceQty == quantity || (btn.dataset.spaceQty === 'custom' && customRow?.style.display !== 'none');
            if (isActive) {
              btn.classList.remove('bg-navy/[0.04]', 'text-navy', 'hover:bg-navy/[0.08]');
              btn.classList.add('bg-teal', 'text-white', 'shadow-[0_2px_12px_rgba(68,131,158,0.3)]');
            } else {
              btn.classList.remove('bg-teal', 'text-white', 'shadow-[0_2px_12px_rgba(68,131,158,0.3)]');
              btn.classList.add('bg-navy/[0.04]', 'text-navy', 'hover:bg-navy/[0.08]');
            }
          });

          // Update form campaign metadata
          donationForm.setAttribute('data-campaign-quantity', quantity.toString());

          // Dispatch event to update the donation form
          donationForm.dispatchEvent(new CustomEvent('campaign-amount-update', {
            detail: { amount, quantity },
            bubbles: true
          }));
        }

        // Button click handlers
        spaceButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const qtyValue = btn.dataset.spaceQty;

            if (qtyValue === 'custom') {
              // Show custom input
              if (customRow) customRow.style.display = '';
              setTimeout(() => quantityInput?.focus(), 50);

              // Update to current input value or default to 1
              const currentQty = parseInt(quantityInput?.value || '1');
              updateSpaceAmount(currentQty);
            } else {
              // Hide custom input
              if (customRow) customRow.style.display = 'none';

              // Set quantity from button
              const qty = parseInt(qtyValue);
              if (quantityInput) quantityInput.value = qty.toString();
              updateSpaceAmount(qty);
            }
          });
        });

        // Custom input handler
        if (quantityInput) {
          quantityInput.addEventListener('input', () => {
            const qty = Math.max(1, parseInt(quantityInput.value) || 1);
            updateSpaceAmount(qty);
          });
        }

        // Initialize with 1 space
        updateSpaceAmount(1);
      }, 100);
    }
  });
</script>
